name: Deploy to TestFlight

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1.0.0, v1.2.3, etc.)
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-upload:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for sync

      - name: Checkout MoneroKit.Swift
        uses: actions/checkout@v4
        with:
          repository: bwgh0/MoneroKit.Swift
          path: MoneroKit.Swift

      - name: Fix MoneroKit path for CI
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Update project.yml to use local path instead of sibling
          sed -i '' 's|path: ../MoneroKit.Swift|path: MoneroKit.Swift|' project.yml
          # Set development team for signing
          sed -i '' "s|DEVELOPMENT_TEAM: \"\"|DEVELOPMENT_TEAM: \"$TEAM_ID\"|" project.yml
          # Regenerate Xcode project
          brew install xcodegen
          xcodegen generate

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install App Store Connect API Key
        env:
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$API_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${API_KEY_ID}.p8

      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project MoneroOne.xcodeproj \
            -scheme MoneroOne

      - name: Build and Archive
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild -project MoneroOne.xcodeproj \
            -scheme MoneroOne \
            -destination "generic/platform=iOS" \
            -archivePath build/MoneroOne.xcarchive \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${API_KEY_ID}.p8 \
            -authenticationKeyID "$API_KEY_ID" \
            -authenticationKeyIssuerID "$API_ISSUER_ID" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            archive

      - name: Export and Upload to TestFlight
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          max_attempts=5
          attempt=1
          backoff=30

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."

            if xcodebuild -exportArchive \
              -archivePath build/MoneroOne.xcarchive \
              -exportPath build/export \
              -exportOptionsPlist ExportOptions.plist \
              -allowProvisioningUpdates \
              -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${API_KEY_ID}.p8 \
              -authenticationKeyID "$API_KEY_ID" \
              -authenticationKeyIssuerID "$API_ISSUER_ID"; then
              echo "Upload succeeded!"
              exit 0
            fi

            if [ $attempt -lt $max_attempts ]; then
              echo "Upload failed. Retrying in ${backoff}s..."
              sleep $backoff
              backoff=$((backoff * 2))
              rm -rf build/export  # Clean up for retry
            fi

            attempt=$((attempt + 1))
          done

          echo "All $max_attempts attempts failed."
          exit 1

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-logs
          path: ~/Library/Logs/DiagnosticReports/
          if-no-files-found: ignore

  sync-to-public:
    needs: build-and-upload
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')  # Only sync on version tags

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to public repo
        env:
          PUBLIC_REPO_PAT: ${{ secrets.PUBLIC_REPO_PAT }}
        run: |
          # Get the tag name
          TAG_NAME=${GITHUB_REF#refs/tags/}

          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # Clone public repo
          git clone https://x-access-token:${PUBLIC_REPO_PAT}@github.com/bwgh0/MoneroOne-public.git public-repo

          # Copy files (excluding .git and private files)
          rsync -av --delete \
            --exclude='.git' \
            --exclude='ICON_SETUP.md' \
            --exclude='.build' \
            --exclude='build' \
            --exclude='DerivedData' \
            --exclude='*.xcuserstate' \
            --exclude='xcuserdata' \
            ./ public-repo/

          # Commit and push
          cd public-repo
          git add -A
          git commit -m "Release ${TAG_NAME}" || echo "No changes to commit"
          git tag -a "${TAG_NAME}" -m "Release ${TAG_NAME}" || echo "Tag already exists"
          git push origin main --tags

          echo "âœ… Synced ${TAG_NAME} to public repo"
